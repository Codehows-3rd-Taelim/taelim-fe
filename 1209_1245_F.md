# 1209_1245_F.md

## `vite.config.ts`

```typescript
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  server: {
    host: "localhost",
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        rewrite: (path) => path.replace(/^\/api/, ""), //ex) :8080/api/carlistë¡œ ì‹œì‘í•˜ëŠ” ì£¼ì†Œì˜ /apië¥¼ ë¹ˆë¬¸ìë¡œ ë³€ê²½
        changeOrigin: true
      }
    }
  }
})
```

## `.env`

```
VITE_API_URL=/api
```

## `src/App.css`

```css
#root {
  margin: 0 auto;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}

.ai-chat-page .MuiContainer-root {
  max-width: 100% !important;
  padding: 0 !important;
}
```

## `src/App.tsx`

```typescript
import './App.css'
import LoginPage from './login/pages/LoginPage'
import { Route, Routes, useLocation } from "react-router-dom"
import { PrivateRoute } from './PrivateRoute'
import OperationManagement from './operationManagement/pages/OperationManagement'
import AiReportPage from "./aiReport/pages/AiReportPage";
import { Container, Box } from '@mui/material'
import Header from './components/Header'
import ReportPage from './report/pages/ReportPage'
import AIChat from './aichat/AIChat'




function App() {
  const location = useLocation();
  const isLoginPage = location.pathname === '/login';

  return (
    <>
      {!isLoginPage && <Header />}
      <Box sx={{ 
        pt: isLoginPage ? 0 : '64px', // í—¤ë” ë†’ì´ë§Œí¼ padding-top ì¶”ê°€
        minHeight: '100vh'
      }}>
        <Container maxWidth="xl" sx={{ maxWidth: '1800px !important' }}>
          <Routes>
            <Route path="/login" element={<LoginPage />} />
            {/* <Route path="/ai/chat" element={<PrivateRoute><Dashboard /></PrivateRoute>} /> */}
            <Route path="/ai/chat" element={<PrivateRoute> <div className="ai-chat-page"><AIChat /></div></PrivateRoute>}
/>

            <Route path="/ai/report" element={<PrivateRoute><AiReportPage /></PrivateRoute>} />
            {/* <Route path="/dashboard" element={<PrivateRoute><Dashboard /></PrivateRoute>} /> */}
            <Route path="/report" element={<PrivateRoute><ReportPage /></PrivateRoute>} />
            <Route path="/manage" element={<PrivateRoute><OperationManagement /></PrivateRoute>} />
          </Routes>
        </Container>
      </Box>
    </>
  );
}

export default App;
```

## `src/type.ts`

```typescript
export type Store = {
    storeId: number;
    shopId: number;
    shopName: string;
    industryId: number;
}

export type Industry = {
    industryId: number;
    industryName: string;
}

export type User = {
    userId: number;
    id: string;
    pw: string;
    name: string;
    phone: string;
    email: string;
    role: "MANAGER" | "USER"; // ê¶Œí•œë¶€ì—¬ì—ì„œ "ADMIN"ì‚¬ìš©ì•ˆí•¨ + ê¶Œí•œì€ í† í°ì„ í†µí•´ì„œ í™•ì¸ í•˜ë¯€ë¡œ "ADMIN"ì œì™¸
    storeId: number;
}

// ApiFormUserëŠ” User íƒ€ì…ì—ì„œ userIdë§Œ ì œì™¸í•œ í˜•íƒœ
export type ApiFormUser= Omit<User, "userId">;

export type LoginRequest = {
    id: string;
    pw: string;
};

export type LoginResponse = {
    jwtToken: string;
    roleLevel: number;
    storeId: number;
    userId: number;
};

export type Robot = {
    robotId: number;
    sn: string;
    mac: string;
    productCode: string;
    softVersion: string;
    work_status: string;
    nickname: string;
    battery: number;
    online_yn: 0 | 1;
    storeId: number;
}

export type Report = {
    reportId: number;
    status: 0 | 1 | 2 | 3 | 4 | 5 | 6;
    startTime: string;
    endTime: string;
    cleanTime: number;
    taskArea: number;
    cleanArea: number;
    mode: 1 | 2;
    costBattery: number;
    costWater: number;
    mapName: string;
    mapUrl: string;
    storeId: number;
    robotId: number;
    sn:number;
}

export type AiChat = {
    aiChatId: number;
    conversationId: number;
    senderType: "USER" | "AI";
    rawMessage: string;
    createdAt: string;
    messageIndex: number;
    userId: number;
}

export type AiReport = {
    aiReportId: number;
    conversationId: number;
    startTime: string;
    endTime: string;
    createdAt: string;
    rawMessage: string;
    rawReport: string;
    userId: number;
    name: string;
}

import { Dayjs } from "dayjs";

// ì»´í¬ë„ŒíŠ¸ì— ì „ë‹¬ë  props íƒ€ì… ì •ì˜
export interface DateRangePickerProps {
  value: [Dayjs | null, Dayjs | null]; // ì„ íƒëœ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼
  onChange: (range: [Dayjs | null, Dayjs | null]) => void; // ë‚ ì§œ ë²”ìœ„ ë³€ê²½ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
  label?: string; // ê¸°ë³¸ í‘œì‹œ ë¼ë²¨ (ë‚ ì§œ ì„ íƒ ì „ í‘œì‹œ)
  fullWidth?: boolean; // ì¶”ê°€ ì˜µì…˜: ì „ì²´ ë„ˆë¹„ ì‚¬ìš© ì—¬ë¶€
  size?: "small" | "medium"; // ì¶”ê°€ ì˜µì…˜: í¬ê¸° ì„¤ì •
};

export interface PaginationProps {
 page: number; // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
  totalPages: number; // ì „ì²´ í˜ì´ì§€ ìˆ˜
  onPageChange: (page: number) => void; // í˜ì´ì§€ ë³€ê²½ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
  maxButtons?: number; // í•œ í™”ë©´ì— ë³´ì—¬ì¤„ ìµœëŒ€ ë²„íŠ¼ ìˆ˜ (ê¸°ë³¸ê°’ 5)
};

export type SenderType = 'USER' | 'AI';

export interface AiChatDTO {
  aiChatId: number;
  conversationId: string;
  senderType: SenderType;
  rawMessage: string;
  createdAt: string; // LocalDateTime
  messageIndex: number;
  userId: number;
  userName: string;
}

export interface ChatPromptRequest {
  message: string;
  conversationId: string | null; // ìƒˆ ëŒ€í™” ì‹œì‘ ì‹œ null
}

export interface ChatMessage {
    id: string; // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©í•  ê³ ìœ  ID (aiChatId ë˜ëŠ” ì„ì‹œ ID)
    conversationId: string;
    senderType: SenderType;
    content: string;
    timestamp: string;
    isPending: boolean; // SSE ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ì§€ ì—¬ë¶€  
}
```

## `src/store.ts`

```typescript
import { create } from "zustand";
import axios from "axios";
import type { LoginResponse } from "./type";

// Store ìƒíƒœ íƒ€ì…
type AuthStore = {
  jwtToken: string | null;
  roleLevel: LoginResponse["roleLevel"] | null;
  storeId: LoginResponse["storeId"] | null;
  userId: LoginResponse["userId"] | null;

  isAuthenticated: boolean;

  login: (params: LoginResponse) => void;
  logout: () => void;
};

// LocalStorage ì´ˆê¸°ê°’ ë¡œë“œ
const initialState = (): Pick<
  AuthStore,
  "jwtToken" | "roleLevel" | "storeId" | "userId" | "isAuthenticated"
> => {
  const jwtToken = localStorage.getItem("jwtToken");
  const roleLevel = localStorage.getItem("roleLevel");
  const storeId = localStorage.getItem("storeId");
  const userId = localStorage.getItem("userId");

  return {
    jwtToken,
    roleLevel: roleLevel ? Number(roleLevel) : null,
    storeId: storeId ? Number(storeId) : null,
    userId: userId ? Number(userId) : null,
    isAuthenticated: !!jwtToken,
  };
};

// Zustand Store ìƒì„±
export const useAuthStore = create<AuthStore>((set) => ({
  ...initialState(),

  login: ({ jwtToken, roleLevel, storeId, userId }) => {
    localStorage.setItem("jwtToken", jwtToken);
    localStorage.setItem("roleLevel", String(roleLevel));
    localStorage.setItem("storeId", String(storeId));
    localStorage.setItem("userId", String(userId));

    set({
      jwtToken,
      roleLevel,
      storeId,
      userId,
      isAuthenticated: true,
    });
  },

  logout: () => {
    localStorage.removeItem("jwtToken");
    localStorage.removeItem("roleLevel");
    localStorage.removeItem("storeId");
    localStorage.removeItem("userId");

    set({
      jwtToken: null,
      roleLevel: null,
      storeId: null,
      userId: null,
      isAuthenticated: false,
    });

    if (window.location.pathname !== "/login") {
      window.location.replace("/login");
    }
  },
}));

// Axios ì¸í„°ì…‰í„°
axios.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem("jwtToken");
    if (token) config.headers.Authorization = `Bearer ${token}`;
    return config;
  },
  (error) => Promise.reject(error)
);

axios.interceptors.response.use(
  (res) => res,
  (error) => {
    const { response } = error;
    const auth = useAuthStore.getState();

    if (response && (response.status === 401 || response.status === 403)) {
      alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
      auth.logout();
    }

    return Promise.reject(error);
  }
);
```

## `src/aichat/api/aiChatApi.ts`

```typescript
import { useAuthStore } from "../../store";

const BASE_URL = import.meta.env.VITE_API_URL || "/api";

export async function requestChatStream(
  message: string,
  conversationId: string | null
) {
  // âœ… Zustandì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
  const token = useAuthStore.getState().jwtToken;

  if (!token) {
    throw new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
  }

  // âœ… Fetch ì‚¬ìš© (SSEì— ìµœì í™”!)
  return fetch(`${BASE_URL}/agent/chat`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}` // â† Zustand í† í°!
    },
    body: JSON.stringify({
      message,
      conversationId
    })
  });
}


export async function loadChatHistory(token: string) {
  const res = await fetch(`${BASE_URL}/chat/history`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  if (!res.ok) throw new Error("Failed to load history");
  return res.json();
}

export async function loadConversation(id: string, token: string) {
  const res = await fetch(`${BASE_URL}/conversation/${id}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  if (!res.ok) throw new Error("Failed to load conversation");
  return res.json();
}
```

## `src/aichat/EmptyState.tsx`

```typescript
interface Props {
  input:string;
  setInput:(v:string)=>void;
  send:(v?:string)=>void;
}

export default function EmptyState({input,setInput,send}:Props){

  const suggestions=[
    "ë¸ŒëŸ¬ì‹œê°€ ì‘ë™ì´ ì•ˆë¼",
    "íšŒì‚¬ ì •ë³´ ì•Œë ¤ì¤˜",
    "ë¡œë´‡ í¬ê¸°ì™€ ë¬´ê²Œê°€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?",
    "ì†Œëª¨í’ˆì€ ì–´ë””ì„œ êµ¬ì…í•˜ë‚˜ìš”?",
    "ì‚¬ìš© ë°©ë²•ì´ ê¶ê¸ˆí•´"
  ];

  const select=(t:string)=>{
    setInput(t);
    send(t);
  };

  return(
    <div className="flex flex-col items-center pt-65 bg-white min-h-full">

      <h2 className="text-[22px] font-semibold mb-6">
        ì•ˆë…•í•˜ì„¸ìš”. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
      </h2>

      <div className="w-[900px] rounded-2xl border shadow-sm p-5 bg-white">
        <textarea
          placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
          value={input}
          onChange={e=>setInput(e.target.value)}
          className="w-full h-[140px] resize-none outline-none text-[15px]"
        />
        <button onClick={()=>send(input)} 
          className="float-right bg-orange-500 text-white px-4 py-2 rounded-lg mt-3">
          í™•ì¸
        </button>
      </div>

      <div className="w-[900px] rounded-2xl border shadow-sm bg-white py-4 px-6 space-y-3">
        {suggestions.map((s,i)=>(
          <button key={i} onClick={()=>select(s)} 
            className="flex gap-2 hover:text-orange-600 text-[15px]">
            ğŸ” {s}
          </button>
        ))}
      </div>

    </div>
  )
}
```

## `src/aichat/ChatWindow.tsx`

```typescript
import ChatInput from "./ChatInput";

interface Props {
  messages: any[];
  input: string;
  setInput: (v: string) => void;
  send: (v?: string) => void;
  scrollRef: any;
}

export default function ChatWindow({ messages, input, setInput, send, scrollRef }: Props) {
  return (
    <div className="h-full flex flex-col justify-between py-10">

      {/* ğŸ”¥ ë©”ì‹œì§€ ë°•ìŠ¤ + ë„ˆë¹„ 900px ì¤‘ì•™ ê³ ì • */}
      <div className="flex flex-col gap-3 w-[900px] mx-auto">
        {messages.map((m, i) => (
          <div key={i} className={`p-3 rounded-xl max-w-[900px] ${m.senderType === "USER" ? "bg-orange-500 text-white self-end" : "bg-white border self-start"}`}>
            {m.rawMessage}
          </div>
        ))}

        <div ref={scrollRef}></div>
      </div>

      {/* ğŸ”¥ ì…ë ¥ì°½ë„ ê°™ì€í­ 900px */}
      <div className="w-[900px] mx-auto">
        <ChatInput input={input} setInput={setInput} send={send} />
      </div>
    </div>
  );
}
```

## `src/aichat/ChatSidebar.tsx`

```typescript
import { useEffect } from "react";

interface Props {
  chatList: any[];
  currentId: string | null;
  select: (id: string) => void;
}

export default function ChatSidebar({ chatList, currentId, select }: Props) {

  return (
    <aside 
      id="sidebar"
      className="w-80 bg-[#fffaf3] border-r px-2 py-4 overflow-y-auto fixed top-16 left-0 h-[calc(100vh-64px)]"
    >
      {/* ğŸ”¹ ìƒˆ ì±„íŒ… */}
      <h2 className="flex items-center gap-1 ml-[15px] text-3xl font-bold mb-3 pt-2 tracking-tight">
        <span className="text-2xl">ğŸ“„</span>
        <span>ìƒˆ ì±„íŒ…</span>
      </h2>


<h2 className="flex items-center gap-1 ml-[22px] mt-[45px] text-[24px] font-semibold text-gray-500 tracking-tight">
  <span>ë‚´ ì±„íŒ…</span>
</h2>




      <div className="flex flex-col gap-1 mt-1">
        {chatList.map(c => (
          <button
            key={c.conversationId}
            onClick={() => select(c.conversationId)}
            className={`p-2 rounded text-left hover:bg-orange-200 transition ${ currentId === c.conversationId
                ? "bg-orange-400 text-white font-semibold"
                : ""}`}
          >
            {c.rawMessage.length > 10 ? c.rawMessage.slice(0, 10) + "â€¦" : c.rawMessage}
          </button>
        ))}
      </div>

    </aside>
  );
}
```

## `src/aichat/ChatInput.tsx`

```typescript
interface Props {
  input: string;
  setInput: (v: string) => void;
  send: () => void;
}

export default function ChatInput({ input, setInput, send }: Props) {
  return (
    <div className="w-full flex justify-center py-12">  {/* ì¤‘ì•™ ê³ ì • & ì—¬ë°± */}
      
      {/* ğŸ“Œ ì—¬ê¸° ê³ ì • 900px => ë©”ì‹œì§€ ì—¬ë¶€ ê´€ê³„ ì—†ì´ ë™ì¼ */}
      <div className="relative w-[900px] bg-white border border-gray-300 rounded-2xl shadow-md p-6">

        <textarea
          value={input}
          onChange={(e)=>setInput(e.target.value)}
          placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
          className="
            w-full h-[160px]
            text-[18px] text-gray-700
            outline-none resize-none leading-relaxed
            placeholder:text-gray-400
          "
        />

        <button
          onClick={send}
          className="
            absolute bottom-5 right-5
            bg-orange-500 hover:bg-orange-600
            text-white font-semibold text-sm
            px-5 py-2 rounded-md transition
          "
        >
          í™•ì¸
        </button>

      </div>
    </div>
  );
}
```

## `src/aichat/AIChat.tsx`

```typescript
import { useEffect, useRef, useState } from "react";
import ChatSidebar from "./ChatSidebar";
import ChatWindow from "./ChatWindow";
import EmptyState from "./EmptyState";
import { loadChatHistory, loadConversation, requestChatStream } from "./api/aiChatApi";

export default function AIChat() {

  const [chatList, setChatList] = useState<any[]>([]);
  const [messages, setMessages] = useState<any[]>([]);
  const [currentId, setCurrentId] = useState<string | null>(null);
  const [input, setInput] = useState("");

  const scrollRef = useRef<HTMLDivElement | null>(null);


  /** ============================================ 
   *   3) ë©”ì‹œì§€ ì „ì†¡ + SSE ì²˜ë¦¬
   * ============================================ */
  const send = async (overrideText?: string) => {
    const message = overrideText ?? input;
    if (!message.trim()) return;

    // (1) í”„ë¡ íŠ¸ì— USER ë©”ì‹œì§€ ë¨¼ì € ì¶œë ¥
    setMessages(prev => [
      ...prev,
      { rawMessage: message, senderType: "USER" }
    ]);
    setInput("");

    // (2) SSE ìš”ì²­ (fetch ë¶„ë¦¬ëœ ë¶€ë¶„ í˜¸ì¶œ)
    const response = await requestChatStream(message, currentId);

    const reader = response?.body?.getReader();
    if (!reader) return;

    const decoder = new TextDecoder();
    let conv = currentId;

    // (3) SSE ìŠ¤íŠ¸ë¦¼ ì½ê¸°
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);

      // ìƒˆ ëŒ€í™”ì˜ ì²« chunkì—ì„œ conversationId ì „ë‹¬ë¨
      if (chunk.includes("conversationId") && !currentId) {
        conv = chunk.replace("event: conversationId\ndata:", "").trim();
        setCurrentId(conv);
      }

      // AI chunk ì¶œë ¥
      setMessages(prev => [
        ...prev,
        { rawMessage: chunk, senderType: "AI" }
      ]);

      scrollRef.current?.scrollIntoView({ behavior: "smooth" });
    }

    // (4) ëª©ë¡ ê°±ì‹ 
    loadChatHistory();
  };

  /** ============================================ 
   *   ìµœì´ˆ ë¡œë”© ì‹œ ëŒ€í™” ëª©ë¡ë§Œ ê°€ì ¸ì˜¤ê¸°
   * ============================================ */
  useEffect(() => {
    loadChatHistory();
  }, []);

  return (
    <div className="flex h-[calc(100vh-64px)] bg-white">
      <ChatSidebar 
        chatList={chatList} 
        currentId={currentId} 
        select={loadConversation} 
      />

      <div className="flex-1 bg-white">
        {messages.length === 0 ? (
          <EmptyState input={input} setInput={setInput} send={send} />
        ) : (
          <ChatWindow 
            messages={messages} 
            input={input} 
            setInput={setInput} 
            send={send} 
            scrollRef={scrollRef} 
          />
        )}
      </div>
    </div>
  );
}
```